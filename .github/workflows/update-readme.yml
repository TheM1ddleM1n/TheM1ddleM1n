name: Auto-update README with Featured Projects

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install PyGithub

      - name: Update README with featured projects
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          import re
          from github import Github
          from datetime import datetime
          
          g = Github(os.environ['GITHUB_TOKEN'])
          user = g.get_user()
          
          # Get top repositories (excluding forks, by stars)
          repos = sorted(
              [r for r in user.get_repos() if not r.fork],
              key=lambda x: x.stargazers_count,
              reverse=True
          )[:6]
          
          # Generate featured projects section
          featured = "### ðŸŒŸ Featured Projects\n\n"
          for repo in repos:
              stars = repo.stargazers_count
              desc = repo.description or "No description"
              featured += f"**[{repo.name}]({repo.html_url})** â­ {stars}\n"
              featured += f"{desc}\n\n"
          
          # Read current README
          with open('README.md', 'r') as f:
              content = f.read()
          
          # Replace featured projects section
          pattern = r'### ðŸŒŸ Featured Projects.*?(?=---|\n## |$)'
          new_content = re.sub(pattern, featured, content, flags=re.DOTALL)
          
          with open('README.md', 'w') as f:
              f.write(new_content)
          
          print(f"âœ“ Updated README with {len(repos)} featured projects")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "Eclipse"
          git config user.email "Eclipse@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update featured projects" && git push)
