name: GitHub Metrics (Optimized & Compressed)

on:
  schedule: 
    - cron: "0 0 */7 * *"  # Every 7 days (reduced from 3 for fewer API calls)
  workflow_dispatch:

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Cache metrics to reduce regeneration
      - name: Cache Metrics
        uses: actions/cache@v4
        with:
          path: |
            metrics.*.svg
          key: metrics-${{ github.run_id }}
          restore-keys: |
            metrics-

      # Ultra-compact activity metrics
      - name: Generate Compact Activity Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: TheM1ddleM1n
          filename: metrics.plugin.activity.svg
          template: classic
          base: header, activity, metadata
          
          # Optimize for smallest size
          config_display: regular
          config_output: svg-compact
          config_padding: 0%
          config_animations: no  # Disable animations
          config_timezone: Europe/London
          
          # Minimal activity data
          plugin_activity: yes
          plugin_activity_limit: 3
          plugin_activity_days: 5
          plugin_activity_load: 100
          plugin_activity_filter: owner
          plugin_activity_visibility: public
          
          # Performance optimizations
          use_prebuilt_image: yes
          delay: 0

      # Install SVG optimizer
      - name: Setup SVG Optimizer
        run: npm install -g svgo

      # Compress SVG files
      - name: Compress SVG Files
        run: |
          echo "Original size:"
          ls -lh metrics.plugin.activity.svg
          
          # Simple but effective optimization
          svgo metrics.plugin.activity.svg \
            --multipass \
            -p 1
          
          echo "Compressed size:"
          ls -lh metrics.plugin.activity.svg
          
          # Calculate reduction
          ORIGINAL=$(git show HEAD:metrics.plugin.activity.svg 2>/dev/null | wc -c || echo "0")
          NEW=$(wc -c < metrics.plugin.activity.svg)
          
          if [ "$ORIGINAL" -gt 0 ]; then
            REDUCTION=$(( 100 - (NEW * 100 / ORIGINAL) ))
            echo "✓ Size reduction: ${REDUCTION}%"
            echo "✓ Original: ${ORIGINAL} bytes"
            echo "✓ Compressed: ${NEW} bytes"
          else
            echo "✓ First generation - no comparison available"
          fi

      - name: Commit and Push Metrics
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add our compressed metrics
          git add metrics.*.svg
          
          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update metrics [compressed] [skip ci]"
          
          # Push with automatic conflict resolution (always use our version)
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push origin main; then
              echo "✓ Successfully pushed metrics"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "⚠ Push failed, attempt $RETRY_COUNT of $MAX_RETRIES"
              
              # Fetch and merge, preferring our version on conflicts
              git fetch origin main
              git merge origin/main -X ours --no-edit
              
              sleep 2
            fi
          done
          
          echo "❌ Failed to push after $MAX_RETRIES attempts"
          exit 1
        
      - name: Log Status
        if: always()
        run: |
          echo "Metrics generation completed at $(date)"
          echo "Job status: ${{ job.status }}"

      # Error notification
      - name: Notify on Failure
        if: failure()
        run: |
          echo "::warning::Metrics generation failed at $(date)"
          echo "::warning::Check if METRICS_TOKEN has required permissions"
